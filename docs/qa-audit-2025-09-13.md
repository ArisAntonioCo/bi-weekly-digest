**QA Audit — 3YMode (2025‑09‑13)**

**Summary**
- Overall app is in solid shape with clear layering (services, utils, UI), Supabase SSR clients, and consistent UI system. Recent authentication fixes address the biggest production issues: invalid link UX, login enforcement, and scanner‑safe confirmation.
- This audit highlights remaining gaps/inconsistencies, proposes concrete fixes, and gives a pragmatic test plan and runbook.

**Release Readiness**
- Overall status: Ready for a limited/beta release; 1–2 short tasks away from a general public launch.
- Beta OK for: Auth flows, protected dashboards, newsletter pipeline, admin tools.
- Hold for GA until these are addressed (1–2 days of work):
  - Add runtime env validation (fail fast if keys are missing).
  - Final RLS pass on user‑owned tables (document policies and verify no admin leakage).
  - Optional but recommended: bundle analysis + error monitoring (Sentry/Logflare) to catch regressions.

Release checklist (go/no‑go)
- Auth
  - [x] Email confirmation enforced on login (server) and scanner‑safe confirm path
  - [x] Resend + inbox quick‑action post‑signup
  - [x] Logout redirects reliably in production
- Data & security
  - [ ] RLS policies reviewed and documented (owner tables scoped to user_id)
  - [x] Service role only used where intended (confirm fallback/admin lookups)
  - [ ] Secrets present in prod: NEXT_PUBLIC_SITE_URL, SUPABASE keys, RESEND, OPENAI, CRON_SECRET
- API & errors
  - [ ] Light request validation on write endpoints (Zod or equivalent)
  - [x] Central error handler + logger wired
- SEO & DX
  - [x] robots.ts and sitemap.ts added
  - [x] Decide public blog strategy (protected for now; marketing excerpts later)
- Ops
  - [ ] Add basic runtime health endpoints or logs (DB ping, email provider reachability)
  - [ ] Error monitoring enabled (optional but recommended)

**High‑Priority Findings**
- Auth confirm UX now redirects to `/login?confirmed=1`. Ensure the login page always renders (no client‑side crashes) and banners display in production across browsers.
- Two server actions also perform signup; both now pass `emailRedirectTo` but should share a single helper to avoid drift.
- Middleware auth check improved; keep a single `middleware.ts` (we removed the duplicate) and ensure all public routes are explicitly allowed.
- Newsletter/AI services rely on env keys (OpenAI/Resend). Add env validation at boot to fail fast.
- Email template in Supabase should remain `{{ .ConfirmationURL }}` only. Avoid custom links there; the redirect is injected server‑side.

**Auth Flows**
- Files: `src/components/signup-form.tsx`, `src/components/login-form.tsx`, `src/app/auth/confirm/page.tsx`, `src/app/auth/confirm/verify/route.ts`, `src/app/(auth)/login/actions/index.ts`, `src/app/(auth)/signup/actions.ts`
- Behaviors now:
  - Signup → if confirmation required, show “check inbox” banner with Resend/Open inbox/Change email (scanner‑safe link).
  - Confirm → immediate server redirect to `/login?confirmed=1`; verify route handles POST fallback when needed.
  - Login → server‑side enforces `email_confirmed_at || confirmed_at`; unconfirmed accounts are blocked.
- Gaps/Recommendations:
  - Add a small success toast on `/login?confirmed=1` (currently a green banner exists; toast would be optional).
  - Optional: add “Resend confirmation” on `/login?error=Invalid verification link` to guide edge cases.
  - DRY signup logic: create `authHelpers.signupWithRedirect(email, password)` used by both server actions and client form.

**Routing & Middleware**
- Files: `src/utils/supabase/middleware.ts`, `middleware.ts (removed)`, `src/app/(auth)/layout.tsx`
- Status: Robust auth detection using JWT‑like cookie structure and explicit public routes (`/`, `/login`, `/signup`, `/auth`, `/privacy`, `/terms`).
- Recommendation: Add `/api/*` passthrough to avoid unintended redirects for API routes (currently handled, but verify if any new endpoints are added).

**Email & Newsletter**
- Files: `src/services/*`, `src/app/api/newsletter/*`, `src/app/api/email-prompt/route.ts`, `src/app/api/subscribers/route.ts`
- Findings:
  - Newsletter service is clean and centralized (send, store, log). Batch sending fallback is present.
  - Email template uses public asset URL; confirm `NEXT_PUBLIC_SITE_URL` is set for absolute OG/asset URLs.
  - Resend integration is straightforward; add transient retry/backoff on 429/5xx.
- Recommendation: Add rate‑limit guard and logging metadata for failed email addresses to improve deliverability triage.

**Database & RLS**
- Files: `src/utils/supabase/*`, `src/services/newsletter.service.ts`
- Observations:
  - App assumes tables: `configurations`, `blogs`, `subscribers`, `newsletter_logs`, `user_roles`.
  - Ensure RLS policies enforce per‑user isolation where applicable (members, user_roles). If any table is admin‑only, use service role exclusively.
- Recommendation: Add a short DB docs (tables + RLS intent) and a `SELECT COUNT(*)` health check endpoint for ops visibility.

**API Endpoints**
- Files: `src/app/api/*`
- Observations: Good error‑handling via centralized error classes. Most endpoints guard with Supabase server client.
- Recommendation: Add Zod validation or a lightweight validator for body/query shapes in endpoints that mutate state.

**SEO & Content**
- Files: `src/app/layout.tsx`, legal pages, blog surfaces
- Status: Global metadata present. Missing `robots.ts` and `sitemap.ts` (not yet added in this pass). Blogs are behind `(protected)`; decide if a public marketing blog is desired for SEO.
- Recommendation: Add `app/robots.ts`, `app/sitemap.ts` with segmented sitemaps (static/legal); later, introduce public blog excerpts if SEO is important.

**UI/UX**
- Files: `src/components/ui/*`, `src/components/*`, `src/app/_sections/*`
- Status: Consistent UI kit; new legal layout with TOC + hero; confirmation banner redesigned (resend + inbox link + change email).
- Recommendation: Add scrollspy smooth‑scroll and toc active link animation. Ensure all modals fit on mobile (we constrained widths/heights; verify visually).

**Performance**
- Observations:
  - Landing sections use dynamic imports with SSR — good balance.
  - Consider image optimization for large assets; ensure video has a small fallback.
  - Add bundle analysis in CI to track regressions.

**Accessibility**
- Observations:
  - Buttons and links have text; ensure icons include `aria-hidden` where decorative.
  - Dialogs use Radix under your wrappers — baseline a11y is strong.
- Recommendation: Add `aria-live="polite"` for async success/error messages where appropriate.

**Observability & Logging**
- Files: `src/lib/logger.ts`, `src/lib/error-handler.ts`
- Status: Solid environment‑aware logger (JSON in prod) and centralized error handling.
- Recommendation: Add request IDs to key API responses/headers for cross‑service tracing.

**Security & Compliance**
- Findings:
  - Edge middleware blocks unauth’d pages; good.
  - Ensure `CRON_SECRET` is strictly enforced for any `/api/cron/*` invocations.
  - Mask secrets in logs, particularly Resend/OpenAI errors.

**Environment & Config**
- Required vars (verify in Vercel):
  - `NEXT_PUBLIC_SITE_URL`
  - `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY` (needed for confirm fallback)
  - `OPENAI_API_KEY`, `RESEND_API_KEY`, `CRON_SECRET`
- Recommendation: Add a small runtime env validator (throw with actionable messages on boot if any are missing).

**Test Plan (Manual)**
- Auth
  - Sign up new email → banner appears → resend works → confirm link → redirected to `/login?confirmed=1` → can sign in.
  - Try login before confirm → blocked with error.
  - Click old email link → “invalid” but account confirmed → redirected to `/login?confirmed=1`.
  - Logout (prod) → redirect to `/login` immediately.
- Legal pages
  - `/terms` and `/privacy` render with left TOC and hero; modals on signup show compact content.
- Newsletter
  - Trigger newsletter send (test API) → confirm logs in `newsletter_logs` and email delivery.
- API
  - Mutations (experts/blogs/newsletter config) return structured errors on invalid payload.

**Actionable Fixes (Recommended)**
- Add `/app/robots.ts` and `/app/sitemap.ts` for basic SEO scaffolding.
- Create `src/lib/env.ts` validator; fail fast on missing critical env.
- DRY signup helpers to a single function used by all initiators.
- Add per‑route Zod validation for API request bodies.
- Add confirm banner toast on `/login?confirmed=1` (optional, polish).

**Open Questions**
- Should blogs be public for SEO? If yes, we’ll split marketing/public content from member-only detail pages.
- Do you want a resend CTA on the login page when `error=Invalid verification link` is present?

**Runbook (Auth)**
- User reports “invalid link” but can’t log in:
  1) Check Supabase Users: is `confirmed_at` or `email_confirmed_at` set?
  2) If yes, direct user to `/login` and sign in; if no, use the signup banner resend.
  3) Confirm `SUPABASE_SERVICE_ROLE_KEY` is set in prod so fallback can detect confirmed status.

**Appendix — Key Files**
- Auth confirm:
  - `src/app/auth/confirm/page.tsx`
  - `src/app/auth/confirm/_page/confirm-redirect.tsx`
  - `src/app/auth/confirm/verify/route.ts`
- Signup/Login:
  - `src/components/signup-form.tsx`
  - `src/components/login-form.tsx`
- Middleware:
  - `src/utils/supabase/middleware.ts`
- Confirmation banner:
  - `src/components/ui/email-confirmation-banner.tsx`
